{
    "componentChunkName": "component---src-templates-md-template-js",
    "path": "/blogs/firestore-learning",
    "result": {"pageContext":{"html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#document-dollection-model\">Document-Dollection Model</a></p>\n</li>\n<li>\n<p><a href=\"#query-fundamentals\">Query Fundamentals</a></p>\n</li>\n<li>\n<p><a href=\"#query-rules\">Query Rules</a></p>\n</li>\n<li>\n<p><a href=\"#data-structuring\">Data Structuring</a></p>\n</li>\n<li>\n<p><a href=\"#security-rules\">Security Rules</a></p>\n</li>\n<li>\n<p><a href=\"#pagination\">Pagination</a></p>\n</li>\n<li>\n<p><a href=\"#transactions\">Transactions</a></p>\n</li>\n<li>\n<p><a href=\"#offline-support\">Offline Support</a></p>\n<ul>\n<li><a href=\"#read\">Read</a></li>\n<li><a href=\"#write\">Write</a></li>\n<li><a href=\"#notes\">Notes:</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#realtime-support\">Realtime Support</a></p>\n</li>\n<li>\n<p><a href=\"#cloud-function\">Cloud Function</a></p>\n<ul>\n<li><a href=\"#why\">Why?</a></li>\n<li><a href=\"#notes-1\">Notes:</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h2 id=\"document-dollection-model\" style=\"position:relative;\"><a href=\"#document-dollection-model\" aria-label=\"document dollection model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Document-Dollection Model</h2>\n<ol>\n<li><strong>Document</strong> is similar to json dictionary, it contains one or multiple <strong>fields</strong> like below:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Document\nbrid_type: \"swallow\"\nairspeed: 42.733\ncoconut_capacity: 0.62\nisNative: false\nicon: &lt;binary data>\nvector: {\n    x: 36.4255\n    y: 25.1442,\n    z: 18.8816\n}\ndistances_traveled: [42, 39, 12, 42]</code></pre></div>\n<ol start=\"2\">\n<li><em>Collection</em> is a collection of documents. It can ONLY contain documents.</li>\n<li>Document can be only &#x3C; 1MB size.</li>\n<li>Document cannot contain another do cument. It can contain <strong>sub-collection</strong> but not other document directly.</li>\n<li>The root of a Firestore tree can only contain collections</li>\n</ol>\n<h2 id=\"query-fundamentals\" style=\"position:relative;\"><a href=\"#query-fundamentals\" aria-label=\"query fundamentals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query Fundamentals</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 331px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d05e2cc0f1d286c96b1dfb6adc2d4c2c/62452/1088f546f7610c493b736096fc47fd1f989476143839d3e0df84599bed1678d5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 148.16326530612244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFeUlEQVRIx41WS28TVxj97LQqVEm6YsmipE1SItRWLPgVYYEIKLBAWQQVgQRigQRBSqSCSSLWkA0oShYQXguUEKw8BFIwEY4lJEhiTOs4ztjxc94eOzO+c6tz8ZhnaUc6nu+bx7nfvXPO/UxERB0dHWRZlt+yLFpeXv4jm83yQqHgFotFN5/P44xcIJ/Pfwo8w3BPkqQw+Oj8+fPEOfdxzkmW5VnOOV9bW3NWVlb45uYmx/n169ci/srh4kcQDgwM1AkVRXnkui5edjKZjKgunU7zZDLJEZumyRVFEZBlmRuG4SqK4hqGAT4mCPv7++uEmqZNVyoVrqqqs7W15SLGwxsbG7xUKokYRJlMhuu6Lq5ZliUGRpWfEaqqOr21tcUrlYoDEqynbds8lUrxWCzGl5eXxdRVVeXlcpknEgnuOI4g/+KUVVV9BEJZlm3HcZjjOK6qqiyZTLJqtSqAPJPJMNM0RV4qlZgsy259yhcuXPhwDecxEtYG08CXtCxLVABgyt5UNU2r56i2XuGhQ4dA6Ecej8f7y+WyyxjTNU0zFUUxGWOmbdt1OI7z0dm2bcNxnLKqqjG6du0azc3N+cbGxkSFwI0bN1qmpqbahoeHfw0EAr9NTk623rp1q/3OnTsCExMT4nz79u22iYmJVuDu3bu/9Pb2Noupdnd30/Hjx+nEiRPU2tpK169fp6GhIfIGuHz5Mo2Pj2MggZs3b9LIyAhdvXqVpqen6eHDhzQ5OUlnz54l8UJnZ2djV1dX44EDBxq7u7sbjxw50jw4OLi9vb191+7du1tGR0e39/b2/nDq1KnmkydPNp85c6b58OHDTd6ADx488M/MzPju3btHlEgkRkzTXDNNc8U0zahhGFGcLctalWX5r3w+/7eu66uapkU/wIqu6+uJROLPGqlvdHRUfA/CV4JIX758KTQG7cFqyKGxrx2apkmnT59uPHfuHC0uLvoEoaZpVdM0q+l0GgZnxWKRbWxsCJ1Bb9CYpmksl8sxXdc9zTk1MccGBgaahoeHaWlpqU4ofAibefaC/t68eSOqlSSJ53I5US3OcEk8Hmc1wr/6+vqaAoEAhcPh94QQLjaCYDDIo9Go2KawGSwsLPClpSWRY1kikQh//PgxLMgYY4Lw4sWLTVeuXPmIkMEVsA72tkql4kqShEHcUqkkAKGnUilX13U3l8u5WCbYE1MG4eDg4Pspwza10YTFMH0AtsJW5eWe7WBFbFc1e2709fU1X7p0iV68ePGOUJKkudq2VDEMwwZKpZJtmqbt5YhxTdd1O5lMIi5jMEmSxj0t3r9//51sDh48+N3CwsLPoVBoVygUagGePXvW4sUf4unTpz8FAoHfw+HwLsR79+79dmxsjGZnZ33pdJoikQjR0aNHKRQK0fPnz7GwwkrA/Pw8HqwDOexFRN9MTU1RMBikffv2iaI6Ozvp2LFjolJ68uQJxWIxfyQS8Xk7DhH59u/f3+D3+xs6OjoaduzY0dDW1ubbtm3b936//8eenh7fzp07G4jIj2dr8N4l2rNnDzHG/NVqlaLRaE+hUEgXCoWEoijrxWJxXZblJOJcLpeSJCknyzKuJ3GvhoQsy+nNzc3gZ10PGyya1OrqKve6HrSJeH19nf/X8cWuBxllMhk7m80yRVGEDWFHWNMwDGFJD2gDNS0zznn1X5tUNpt1IG7oDy0T1oNUkMM1aK1wUE2bLuIvdj1FUaar1SoauwM/e55+9eoVf/v2rVgK7EoYAM0/Ho/zxcVFIfivdj1FURzGmIv1RFXwNpYCQFVorzAE7sOu6NX1Cj/pejO4g0YP+6H/ghCxB1zz/kHgHnIsT73Crq4uEDbUut4QRuWcO97/lf9xiOd0Xc//A7kmHQKx6PN0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"picture 57\"\n        title=\"picture 57\"\n        src=\"/static/d05e2cc0f1d286c96b1dfb6adc2d4c2c/62452/1088f546f7610c493b736096fc47fd1f989476143839d3e0df84599bed1678d5.png\"\n        srcset=\"/static/d05e2cc0f1d286c96b1dfb6adc2d4c2c/86a2e/1088f546f7610c493b736096fc47fd1f989476143839d3e0df84599bed1678d5.png 245w,\n/static/d05e2cc0f1d286c96b1dfb6adc2d4c2c/62452/1088f546f7610c493b736096fc47fd1f989476143839d3e0df84599bed1678d5.png 331w\"\n        sizes=\"(max-width: 331px) 100vw, 331px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>To navigate in your database, we are will do something like: <code class=\"language-text\">firestore.collection(...).document(...).collection(...).document(...)</code>. Or, we can also access the data by providing a path to that document like this: <code class=\"language-text\">firestore.document(\"/users/user_123/workouts/workout_abc/history/05182017\")</code></li>\n<li>In Firebase, query is <strong>shallow</strong> by default. If you grab a parent level document, sub collection will be grabbed.</li>\n</ol>\n<h2 id=\"query-rules\" style=\"position:relative;\"><a href=\"#query-rules\" aria-label=\"query rules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query Rules</h2>\n<ol>\n<li>Firestore will index your fields with a \"type\". Indexing means the DB will</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 671px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/819bafac2d42f62221f4c9d3ef37f8f6/d0e73/d69814208d57dfcc4d996ed12242df5d796d4688893b6da929e53d4c24b18465.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.6530612244898%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6klEQVQY01WQwY7DMAhE8//fWKmnSm0S2xDAxIkxqzWrSvtOCA0Dw+ITM2NmETEzdx9juDsippT8P9u2MXNoFiLCyfP5fDwepZSv7r5vAEDEYxK+qlpKAYDjOBYAWNeViJh53/ec8xiDmccYvfdtklLKOcdwrXVd18/nk3NeWmvM3CaIWGtFxNfrlVICAJ6oakqpTlSVmRFRRBZVJaLW2nmeRCQi13WZ2XVdtda4SFVzztH/Nn+HRaSUEpb7vhNRfMvdW2sAUEohovf73Xt391j7l7n3bma99/u+o/g+7DxPEYnwZhamkTGUPxNUk7TpcdX9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"picture 59\"\n        title=\"picture 59\"\n        src=\"/static/819bafac2d42f62221f4c9d3ef37f8f6/d0e73/d69814208d57dfcc4d996ed12242df5d796d4688893b6da929e53d4c24b18465.png\"\n        srcset=\"/static/819bafac2d42f62221f4c9d3ef37f8f6/86a2e/d69814208d57dfcc4d996ed12242df5d796d4688893b6da929e53d4c24b18465.png 245w,\n/static/819bafac2d42f62221f4c9d3ef37f8f6/41d3c/d69814208d57dfcc4d996ed12242df5d796d4688893b6da929e53d4c24b18465.png 490w,\n/static/819bafac2d42f62221f4c9d3ef37f8f6/d0e73/d69814208d57dfcc4d996ed12242df5d796d4688893b6da929e53d4c24b18465.png 671w\"\n        sizes=\"(max-width: 671px) 100vw, 671px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol start=\"2\">\n<li>Idealy, query should only happen in one collections. For example we have a tree like this: [Restaurants] -> [Reviews]:\n<ul>\n<li>We can query for one restaurant, what are the reviews which have more than 4 stars;</li>\n<li>Query spam among several collections is called Collection Group Query. For example, if we want to get all reviews higher than 4 stars amoung all restaurants, we need to define:\n<ul>\n<li>Colleciton ID: \"reviews\"; Field path: \"rating\"; Index Scope: \"Collection group\"</li>\n<li>This will tell the DB to index the rating fields of every documents in any collection with ID of \"reviews\"</li>\n<li>The number of this kinds of CGQ is limited - 200</li>\n<li>This will index all the collections with the same name. So if there are some unrelated collections of Reviews, they will also be indexed.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Firestore does not support \"query in one collection then use the queried information to make another query\". For example, we cannot query user document in users collections and then join the reviews from that user.</li>\n<li>Fields can only be queried by using \">\", \"&#x3C;\", \"==\". (Because they are sorted.) The idea of Firestore querying is, it will only do query by a. finding one point in the sorted index(using binary search); b. grab adjacent items of that point. For example, \"or\" and \"not\" queries are not supported.</li>\n<li>We can join two fields in one collection, for example, we can do \"query all restaurants <strong>city=='SF' and cuisine=='Japanese'</strong>\". This is done by doing \"zig-zag\" querying.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f21fa125854b4e2427c55f3209cd5c54/efc6e/8c56796cf1fb4bd8eeeddce02aaa194e6ef268f9d5ef3b5e412bdb4834258af9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 106.53061224489795%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsTAAALEwEAmpwYAAADh0lEQVQ4y12U6XbiOBSE/f7PMz0d0p2QZkkMsYMx3uRN8ipbiw3ewBDwHOCcPpl8/0tV0r0lwbZtVVU1TYMQEkIMw3Acp67r4Qtt2yZJomma67qEkDRNdV1HCAmEEE3TFEXhnJdl6Xme7/v7/f6ruOs6jLGiKJ7ncc6LokAIlWUppGlq2zYAgDFGCMEYZ1n2zblpmrvbPR2l1PM8QoiAMb47U0oZY3EcJ0nSNO232Hdn13XZDdu2GWMCxtcjVVVllFFKIIRBEDRN8805DENZlgEA92gAgCzLhIkaTRQ4ltw3PQ6Lk2hmIshp1e+79ng8/hUjhGRZtizrLlZVNQxDwRVX7lLRZ0tPWneY+u/rQN7wBB/6Q1VV5/P5LiaEqKoKIWSMUUoty7remTw/ZeMxfvrNXudn3yumk918VjgO317pum4Yhrqu8zw3TSsMI0IpoRQAO8+JkE5n0XTmPY8TcXEKo0KSqo+P3HG6w6FtGs757cGasuCmoUdhUBa84Mx1bEaJkD38TEYP4Y9/svHz2bHzx0f665EDUHfd5XymlLVNHaRMsunzEvyRfZA0XtZOV0iFW0GXdF3arN5WpmJu89I3YGCFyENN29yHxBm1YbJB5R8JzFYeon1anmSQ27gTREAXgMz1RHZoVJ428V7HR5jwtqmGYTifL4d9l5LdGm7nayTqiZ8fouKkBQ3AB0E0UlGPZwqUrBRXl6WJJZsGuNiWRdtdqaodiokGi6kE3hQYkkPC+/mHZ8e1kExm8ew1eJnixfsRBVR8L5ZSiYJ2vz8cDn3fb0uOcLEK2okazY3MoaegvMhwZ+QnwVqsjDd5PVkASa0zBhUj0uzA8Rnnx+Ox7/u2ayMUId2XJsuPmcxCUuLCVZ3Mx8KrmoibaPoB340kZL3ilRtU+xHtuuZyuVRV1fV9FYbsZez8+wM9PHRrZW/o8eOoWYhC+muUPP9GDz/TPy8D9Pn0pZpPqWURXrRN8/n5ea3kfh+m6fvHykOIFAUtSseHbLsTsOtBXfc2GxZFBca5DylC7W73tRhVVTHGgGUlcUwIYZRGYcgoFVAUbXR9tV7HaUo5d30fBkHT/q+SdV3/3W16AyF03W0EoWkY2maTJkmeZZZp2gB8q2RVVXme3z+D7IZpmtdKyrL89PQ0Go1UVUUIiaK4WCyKohiG4XJjGAbOuWEYo9FouVy6NyRJsizrP444YklzMdyGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"picture 65\"\n        title=\"picture 65\"\n        src=\"/static/f21fa125854b4e2427c55f3209cd5c54/efc6e/8c56796cf1fb4bd8eeeddce02aaa194e6ef268f9d5ef3b5e412bdb4834258af9.png\"\n        srcset=\"/static/f21fa125854b4e2427c55f3209cd5c54/86a2e/8c56796cf1fb4bd8eeeddce02aaa194e6ef268f9d5ef3b5e412bdb4834258af9.png 245w,\n/static/f21fa125854b4e2427c55f3209cd5c54/efc6e/8c56796cf1fb4bd8eeeddce02aaa194e6ef268f9d5ef3b5e412bdb4834258af9.png 441w\"\n        sizes=\"(max-width: 441px) 100vw, 441px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n<ul>\n<li>Above Zig-zag query makes sense when the query is \"equal and equal\". For \"<strong>less and equal</strong>\" type of query, it's tricky, because the zig-zag only works when the ID is sorted, but for \"less-than\" query, ID is not sorted.</li>\n</ul>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 621px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9515f032b8a9d08b21b81ec56e663955/3075e/a470972d8c16bbbfd7d93b2b5c774cea2065b9b96cfd5b508d7000e9930ab63b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.51020408163265%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAACCUlEQVQoz12T2XLiMBBF+f9fSgaoBKpSQKBcDNhIlhdhWfImI+8LNlNYjCHpB710H93u29Lk9hJlWTqOgzEWQgAAXNft+37Mtm2LMVZVlVLqOI5pmpNXuCgKXdchhJxzy7J83++6rh/idrvVde15nmEYURQRQlzXvcNjWsKn0ymKIsdxgiDouk4WSJhSCgAIguB8PmOMfysDAFRV5ZwjhDzPE0IwxoIgKMuyaRpKKULoCdd1naZpnucShhBqmhbHsa7rlNJ2iOv1WlVVURSMMals2/Z95qIooihKkqSu6zzPJcw5NwyDMSbblj2/whhj27afbVdVlWWZDsADRohROsLX6zVNUwmHYYgxtixrMvpxh/McGoYGQBTHFsZscHu8Xc4vlSmlD7dlNG0bM2Ypir7bpZS6msYxft2zEMIlBADg+z4hhDjOf3ioqikN5nMym90QCj4/M0V5bqLvRZIQxjQIme+fXRc/laVCHPuLBfn46Ewz+f4uVPV1kXEYcgDwbpdhHBmGfzr9hMOQ/Zme3987COPFMh+Vh2ybptlqxabT9nBIt7vLYvEDbkRibjZovc4IoYcDN8zHzPKsqny7defzRlVzRRHL5QOWthRlCRACCHEhoGm6nvdwe4D7sszWGzabt8dj+ncvVqvJr18l3/blcrnveXwkUrkss83Gfntrj8div0++vv4Bvp1D6S7Jth4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"picture 66\"\n        title=\"picture 66\"\n        src=\"/static/9515f032b8a9d08b21b81ec56e663955/3075e/a470972d8c16bbbfd7d93b2b5c774cea2065b9b96cfd5b508d7000e9930ab63b.png\"\n        srcset=\"/static/9515f032b8a9d08b21b81ec56e663955/86a2e/a470972d8c16bbbfd7d93b2b5c774cea2065b9b96cfd5b508d7000e9930ab63b.png 245w,\n/static/9515f032b8a9d08b21b81ec56e663955/41d3c/a470972d8c16bbbfd7d93b2b5c774cea2065b9b96cfd5b508d7000e9930ab63b.png 490w,\n/static/9515f032b8a9d08b21b81ec56e663955/3075e/a470972d8c16bbbfd7d93b2b5c774cea2065b9b96cfd5b508d7000e9930ab63b.png 621w\"\n        sizes=\"(max-width: 621px) 100vw, 621px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n<ul>\n<li>for this kind of query pattern, we can create <code class=\"language-text\">composite indexes</code> for this type of query - <code class=\"language-text\">zuocode_rating</code>:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    restaurants<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">\"BurgerThyme!\"</span>\n            address<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                addr_1<span class=\"token operator\">:</span> <span class=\"token string\">\"123 Fake Street\"</span>\n                city<span class=\"token operator\">:</span> <span class=\"token string\">\"San Francisco\"</span>\n                state<span class=\"token operator\">:</span> <span class=\"token string\">\"CA\"</span>\n                zip<span class=\"token operator\">:</span> <span class=\"token string\">\"94045\"</span>\n            <span class=\"token punctuation\">}</span>\n            cuisine<span class=\"token operator\">:</span> <span class=\"token string\">\"Burgers\"</span>\n            avg_rating<span class=\"token operator\">:</span> <span class=\"token number\">4.76</span>\n            zipcode_rating<span class=\"token operator\">:</span> <span class=\"token string\">\"94045_4.76\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Firestore can do this for us <strong>automatically</strong>. We can manually use Firestore UI to create this composite index or, we can run the query and Firestore will detect this kind of query and generate link for us to create them.</li>\n<li>With this technic, we can do \"equal\\equal\\equal...\\equal\\less_than(more_than)\" query.</li>\n</ul>\n</li>\n<li>Array in Firestore does not support 'insertAt(idx, el)', 'deleteAt(idx, el)', 'retrieve(idx)'\n<ul>\n<li><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4fd9bdda93f2c30bc05f94107c53f686/efc6e/a8efbb759341969c0e18eaf4ca7b1f2ddde16e6f99ab2b0a5f566557a0d5ef01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.183673469387756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhklEQVQoz42S0Y6qMBBA+f9/0viiDyYmCgLRxERbSisFOu2AWKp243Yvd7P7suepSed0ZjoTCSGKohBCMMbquu66Dv9MpLU+n89CCEqpMcZ7/3q9/N+IhBDW2uGTvu8RsWkarfXtE0Q0xmitAQARpxhE1FpHRVGUZUkIQcTwXtM0jLGqqjjnzjnvvbVWKSWlbNsWEUNpt9stopQyxkLZfd9779u2vVwujDFKqVKq67pxHAGAUso5r+s65PiS8zzPsux4PFprp8wAIISoqgoAnHMAsN/vsyzbbDahxrfMOZdScs6HYQhPKqUOh8N2uyWEDMPgnBvHUWsdaqGU3u/3L5kQMp/Pl8vl6XQCgCCnaTqbzfI8X61WaZo+Hg8AyPM8juNpKMMwRGVZ7na79XpNCCnL0jnXtm3XdSGh/YcxJkmSxWIRx3Fo+y1XVWWMUUoh4vV6fT6fTdNMLQSCTClNkkQp9f/DpJQ/Ri+l/C0rpcLYJt6yEMJ8AxEBQGv9fQ3DVdiTEBMOH+hSonGg12l3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"picture 63\"\n        title=\"picture 63\"\n        src=\"/static/4fd9bdda93f2c30bc05f94107c53f686/efc6e/a8efbb759341969c0e18eaf4ca7b1f2ddde16e6f99ab2b0a5f566557a0d5ef01.png\"\n        srcset=\"/static/4fd9bdda93f2c30bc05f94107c53f686/86a2e/a8efbb759341969c0e18eaf4ca7b1f2ddde16e6f99ab2b0a5f566557a0d5ef01.png 245w,\n/static/4fd9bdda93f2c30bc05f94107c53f686/efc6e/a8efbb759341969c0e18eaf4ca7b1f2ddde16e6f99ab2b0a5f566557a0d5ef01.png 441w\"\n        sizes=\"(max-width: 441px) 100vw, 441px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></li>\n<li>For above collections, we can make query like: <code class=\"language-text\">collection(\"dickens_books\").where(\"keywords\", \"array-contains\", \"drama\")</code></li>\n<li>This can be done because behind the scene, Firestore is converting the keywords list to a map: <code class=\"language-text\">keywords: [\"orphan\", \"crime\", \"London\", \"thieves\"]</code> -> <code class=\"language-text\">keywords: {\"orphan\": true, \"crime\": true, \"London\": true, \"thieves\": true}</code></li>\n</ul>\n</li>\n</ol>\n<h2 id=\"data-structuring\" style=\"position:relative;\"><a href=\"#data-structuring\" aria-label=\"data structuring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data Structuring</h2>\n<ol>\n<li>Do not make document too big (size[1mb max] and fields[20,000 fields]):\n<ul>\n<li>Document has limits</li>\n<li>Document cannot be retrieved (and controlled by security rule) partially</li>\n</ul>\n</li>\n<li>And, do NOT make document too small (fragmented)\n<ul>\n<li>data retrieving is shallow</li>\n<li>you are billed by the number of reads and writes you perform</li>\n<li>Do not pre-maturely optimize the data structure in order to reduce billing</li>\n<li>Queries find documents in single collection</li>\n</ul>\n</li>\n<li>Put data in the same document if they are always displayed together</li>\n<li>Put data in collection if <strong>you are going to search for individual piece of the data or if you are expecting it to have rome to grow</strong></li>\n<li>As an exmaple of restaurants database, let's say we store \"reviews\" as a sub-collection under restaurant document. And in our app, we are going to display one restaurant with several (not all) reviews. For this use case, what we can do is create a field inside of restaurant document for \"<strong>review_preview</strong>\" and store latest (or some other order) reviews. We have Cloud Function to keep this in sync.</li>\n<li>For \"flag\" style data, we can either store a map of key-><code class=\"language-text\">true</code> or, we can store them in a list. But, according to the video, the approach of list will not allow you to do 2 attributes query. List is friendly for security rules, like \"who is allowed to edit the restaurant\".\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">\"some restaurant\"</span>\n    cuisine<span class=\"token operator\">:</span> <span class=\"token string\">\"French\"</span>\n    rating<span class=\"token operator\">:</span> <span class=\"token number\">4.92</span>\n    attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        takes_reservations<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n        romantic<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n        kid_friendly<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n    editors<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>userID_2852<span class=\"token punctuation\">,</span> userID_4582<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// or, better solution for this editor list, so we can do security rule as:</span>\n    <span class=\"token comment\">// allow write if: restaurant.roles[userId] = \"editor\"</span>\n    roles<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        userId_2852<span class=\"token operator\">:</span> <span class=\"token string\">\"editor\"</span>\n        userId_4571<span class=\"token operator\">:</span> <span class=\"token string\">\"editor\"</span>\n        userId_8123<span class=\"token operator\">:</span> <span class=\"token string\">\"owner\"</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// however, this approach might leak some information for security reason, a better option is to store this kind of information outside of this collection</span>\n    <span class=\"token comment\">// or, we can have a sub-collection called \"private data\" and only contain this kinds of secrity data</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ol>\n<h2 id=\"security-rules\" style=\"position:relative;\"><a href=\"#security-rules\" aria-label=\"security rules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Security Rules</h2>\n<blockquote>\n<p>Below will not cover security coming from server libraries, for example: cloud functions.</p>\n</blockquote>\n<ol>\n<li>A security rulle will specify:\n<ol>\n<li>what specific documents you are securing</li>\n<li>what logic you are going to secure them.</li>\n</ol>\n</li>\n<li>here is an example of security rule, it really just an example, does not make too much sense\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">service cloud.firestore {\n    match /databases/{database}/documents {\n        match /{document=**} {\n            // Completely locked\n            allow read, write: if false;\n        }\n        // ----------------------------------\n        match /restaurants/{restaurantID} {\n            // (i)\n        }\n        match /restaurants/{restaurantID}/reviews/{reviewID} {\n            // the rules placed here is the same as what it has in (ii)\n        }\n        // ----------------------------------\n        match /restaurants/{restaurantID} {\n            match /reviews/{reviewId} {\n                // (ii)\n                allow write: if reviewId == \"review_234\"\n            }\n        }\n        // ----------------------------------\n        match /myCollection/{docId} {\n            allow read: if request.auth.token.email.matches('.*google[.]com$');\n        }\n    }\n}</code></pre></div>\n</li>\n<li>the <code class=\"language-text\">{database}</code> in this rule is to \"wild cards\" all the database in firestore. 2 kinds of wildcard:\n<ol>\n<li>Single element wildcard - <code class=\"language-text\">{database}</code> or <code class=\"language-text\">restaurantID</code>:\n<ol>\n<li>it's just to say: go ahead and match a single path element, either a document or a collection, and stick it into a variable with the name that I specified here.</li>\n<li>so at the place - (i), we will have a variable named <code class=\"language-text\">restaurantId</code> and its value is the ID of the restaurant doc</li>\n<li>this variable will be available in nested security rule, like place (ii)</li>\n</ol>\n</li>\n<li>\"Rest of the document path wild card\" - <code class=\"language-text\">{document=**}</code>\n<ol>\n<li>it says: go ahead and match the rest of the path and stick it into this variable here</li>\n<li>now the <code class=\"language-text\">document</code> will be the rest of the path</li>\n</ol>\n</li>\n</ol>\n</li>\n<li><strong>WARNING</strong>: the security ruls for the parent document will not be cascade to the nested collection!</li>\n<li><strong>WARNING</strong>: security rules will be an <em>ORDERED</em> matcher list. First will be applied and if it does not work, the second will be applied... So be careful of some \"powerful\" rules which can override following rules.</li>\n<li>For the rule string - <code class=\"language-text\">allow read: if reviewId == \"review_234\"</code>:\n<ol>\n<li>only <code class=\"language-text\">allow</code> keyword is provided. There is no <code class=\"language-text\">disallow</code>. If you want to \"block\", you can <code class=\"language-text\">allow read: if false</code></li>\n<li>verbs:\n<ol>\n<li><code class=\"language-text\">read</code> includes <code class=\"language-text\">get</code> and <code class=\"language-text\">list</code></li>\n<li><code class=\"language-text\">write</code> includes <code class=\"language-text\">create</code>, <code class=\"language-text\">delete</code> and <code class=\"language-text\">update</code></li>\n</ol>\n</li>\n</ol>\n</li>\n<li><code class=\"language-text\">request</code> is the \"input\" of the security rule. It contains 2 things:\n<ol>\n<li>auth\n<ol>\n<li>whether they're an actual signed-in user: <code class=\"language-text\">allow read: if request.auth != null</code></li>\n<li>allow people only when the email from the domain of \"google.com\" and verified: <code class=\"language-text\">allow read: if request.auth.token.email.matches( '.*google[.]com$') &amp;&amp; request.auth.token.email_verified;</code></li>\n</ol>\n</li>\n<li>resource\n<ol>\n<li>security rule can be used to \"define the data restriction\": <code class=\"language-text\">allow create: if request.resource.data.score is number &amp;&amp; request.resource.data.score >= 1 &amp;&amp; request.resource.data.score &lt;= 5</code></li>\n<li>with \"resource\", we can also define some rules to \"only let the owner to edit/read the document\": <code class=\"language-text\">allow update: if request.resource.data.reviewerId = request.auth.uid</code></li>\n</ol>\n</li>\n</ol>\n</li>\n<li><code class=\"language-text\">resource</code> is another object can be used in security rules representing the existing document in database:\n<ol>\n<li>for example, user cannot change the score: <code class=\"language-text\">allow update: if request.resource.data.score == resource.data.score</code></li>\n</ol>\n</li>\n<li><strong>WARNING</strong>: security rule is NOT a filter, it will block a request to a collection and any of the documents failed the security rule.</li>\n<li><code class=\"language-text\">get()</code> function can allow you to retrieve data from another document for security rule validation:\n<ol>\n<li><code class=\"language-text\">allow update: if get(/databases/$(database)/documents/restaurants/$(restaruantID)/ private_data/private).data.roles[request.auth.uid] in [\"editor\", \"owner\"]</code></li>\n</ol>\n</li>\n<li>Custom Auth Claim: Cloud function can be used to define some fields for security rules. The number is limited.</li>\n<li>Security Rule support functions:\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">function doesUserHaveGoogleAccount() {\n    return request.auth.token.email.matches('.*google[.]com$') &amp;&amp; request.auth.token.email_verified\n}\n\n//...\nallow update: if doesUserHaveGoogleAccount()</code></pre></div>\n</li>\n</ol>\n<h2 id=\"pagination\" style=\"position:relative;\"><a href=\"#pagination\" aria-label=\"pagination permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pagination</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">myQuery <span class=\"token operator\">=</span> restaurantRef<span class=\"token punctuation\">.</span><span class=\"token function\">whereField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"city\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">isEqualTo</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tokyo\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">whereField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"category\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">isEqualTo</span><span class=\"token operator\">:</span> \"tempura<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">order</span><span class=\"token punctuation\">(</span>by<span class=\"token operator\">:</span> <span class=\"token string\">\"rating\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">descending</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>to<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Above query Will provide the first 20 documents matches this query.</p>\n<p>To get the next batch of data:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">nextBatch <span class=\"token operator\">=</span> restaurantRef<span class=\"token punctuation\">.</span><span class=\"token function\">whereField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"city\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">isEqualTo</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tokyo\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">whereField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"category\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">isEqualTo</span><span class=\"token operator\">:</span> \"tempura<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">order</span><span class=\"token punctuation\">(</span>by<span class=\"token operator\">:</span> <span class=\"token string\">\"rating\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">descending</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>to<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span>after<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Tokyo\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tempura\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// or </span>\nnextBatch <span class=\"token operator\">=</span> myQuery<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span>after<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Tokyo\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tempura\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// however, this will potentially skip documents. </span>\n<span class=\"token comment\">// So we can do:</span>\nmextBatch <span class=\"token operator\">=</span> myQuery<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span>after<span class=\"token operator\">:</span> previousDoc<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// previousDoc is the LAST document of the previous batch</span></code></pre></div>\n<p><strong>WARNING</strong>: if the collection is constantly updated, for example some documents are deleted and inserted, those updates might be skipped. To avoid this, in the 2nd query, you should increase the <code class=\"language-text\">limit(to: 40)</code> then <code class=\"language-text\">60</code>.</p>\n<h2 id=\"transactions\" style=\"position:relative;\"><a href=\"#transactions\" aria-label=\"transactions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Transactions</h2>\n<p>Batch Write is for Atomic: DB will make sure that one batch write will success for all or failed for all'</p>\n<p>Transaction is for Most-up-to-date, 5 steps to perform a transaction:</p>\n<ol>\n<li>before writing to DB, it will first read the dcoument;</li>\n<li>then, client will have some logic to update the data in the document;</li>\n<li>the update will be performed;</li>\n<li>then, double check the right change was made;</li>\n<li>finally, all changes will be commited.</li>\n</ol>\n<p><strong>When we want to increment or decrement a value, we need to use transaction.</strong></p>\n<h2 id=\"offline-support\" style=\"position:relative;\"><a href=\"#offline-support\" aria-label=\"offline support permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Offline Support</h2>\n<blockquote>\n<p>On Andriod and iOS devices, offline support is enabled by default.</p>\n</blockquote>\n<h3 id=\"read\" style=\"position:relative;\"><a href=\"#read\" aria-label=\"read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Read</h3>\n<p>The offline mode for read works in Firestore likes following:</p>\n<ol>\n<li>[online] You queried Firestore for the top 30 sushi restaurants in SF sorted by price</li>\n<li>[online] You queried for the top 30 burger restaurants in SF sorted by price</li>\n<li>[offline] now you can still query for top 30 restaurants in SF sorted by rating. This query will work across the cache data.</li>\n</ol>\n<h3 id=\"write\" style=\"position:relative;\"><a href=\"#write\" aria-label=\"write permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Write</h3>\n<p>When you make a change to a document, that data will be store on the local device and whether you are online or not, you data will immediately give you the appearence that your change has gone into effect. Any real-time listeners that are watching this data will trigger with your updated data.</p>\n<p>By the meantime Firebase will take your change and attempt to send it to the server. After you are online, Firebase library will update your data for reals, and will remove that pending write.</p>\n<p>As a summary, offline write will be queued and will be replayed when device goes online. If multiple devices are writing the same document, last write (to the server, even it actually happened before the other) will be applied.</p>\n<h3 id=\"notes\" style=\"position:relative;\"><a href=\"#notes\" aria-label=\"notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes:</h3>\n<ol>\n<li>Firebase library for web is not enabled for offline support by default</li>\n<li>The callback function of <code class=\"language-text\">collection.add()</code> will not be triggered when it's in offline mode, because your app is still waiting for the response from the server. When use Firebase, because it has a cache, we don't need to add a callback to handle the fresh data.</li>\n<li>Transaction will fail in offline mode</li>\n<li>Offline cache is not indexed so the query will take some time.</li>\n<li>The default behavior is good enough to ensure a good offline experience.</li>\n</ol>\n<h2 id=\"realtime-support\" style=\"position:relative;\"><a href=\"#realtime-support\" aria-label=\"realtime support permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Realtime Support</h2>\n<blockquote>\n<p>The main takeaway here is that you should start thinking of realtime as your default behavior, then only switch to one-time fetch call only when you have a good reason to make that change.</p>\n</blockquote>\n<h2 id=\"cloud-function\" style=\"position:relative;\"><a href=\"#cloud-function\" aria-label=\"cloud function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Function</h2>\n<blockquote>\n<p>When an database action is fired, you can hook a cloud function to this action and execute some custom logic.</p>\n</blockquote>\n<h3 id=\"why\" style=\"position:relative;\"><a href=\"#why\" aria-label=\"why permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why?</h3>\n<ol>\n<li>With cloud function, \"backend logic\" is hosted at the backend (instead of managed by client). So you can easily update it by deploying to backend instead of updating client application;</li>\n<li>Clients are not trustworthy;</li>\n</ol>\n<h3 id=\"notes-1\" style=\"position:relative;\"><a href=\"#notes-1\" aria-label=\"notes 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes:</h3>\n<ol>\n<li>Infinite loop: when you have a cloud function executed <code class=\"language-text\">onChange()</code>, and in this function you modify the data, the same function will be triggered again.</li>\n<li>admin serverside sdk will bypass the security rules.</li>\n<li>Lazy import is preferred because otherwise all of your cloud function will load those library</li>\n</ol>","date":"June 01, 2022","tags":["blog","mymanual","firebase","firestore"],"title":"MyManual: Firestore","description":"Learning notes on Firestore"}},
    "staticQueryHashes": []}