{
    "componentChunkName": "component---src-templates-md-template-js",
    "path": "/blogs/firebase-hands-on",
    "result": {"data":{"markdownRemark":{"html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#official-tutorial-develop-locally-with-firebase\">Official tutorial: Develop locally with Firebase</a></p>\n<ul>\n<li><a href=\"#firestore-database\">Firestore Database</a></li>\n<li><a href=\"#cloud-function\">Cloud Function</a></li>\n<li><a href=\"#security-rules\">Security Rules</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h2 id=\"official-tutorial-develop-locally-with-firebase\" style=\"position:relative;\"><a href=\"#official-tutorial-develop-locally-with-firebase\" aria-label=\"official tutorial develop locally with firebase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Official tutorial: <a href=\"https://firebase.google.com/learn/pathways/firebase-emulators#codelab-https://firebase.google.com/codelabs/firebase-emulator\">Develop locally with Firebase</a></h2>\n<ul>\n<li>The tutorial is based on this github repo: <a href=\"https://github.com/firebase/emulators-codelab\">https://github.com/firebase/emulators-codelab</a></li>\n<li>Install Firebase CLI: <code class=\"language-text\">npm install -g firebase-tools</code></li>\n<li>Initialize a Firebase project:\n<ul>\n<li>Log to <a href=\"https://console.firebase.google.com/u/0/\">Firebase console</a> to create a new project, copy the <strong>project ID</strong></li>\n<li><code class=\"language-text\">firebase login</code></li>\n<li><code class=\"language-text\">firebase use $project-id</code> to link to the cloud resources</li>\n</ul>\n</li>\n<li>Start the emulator: <code class=\"language-text\">firebase emulators:start --import=./seed</code></li>\n</ul>\n<blockquote>\n<p>How to generate testing data - \"./seed\"?</p>\n</blockquote>\n<ul>\n<li>If emlator starts failed, might because of the port number is already in used. Change the port number in <code class=\"language-text\">firebase.json</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Firebase use below way to fetch resources</span>\n<span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> firebaseApp<span class=\"token punctuation\">.</span><span class=\"token function\">auth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> db <span class=\"token operator\">=</span> firebaseApp<span class=\"token punctuation\">.</span><span class=\"token function\">firestore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// This lines are added to public/js/homepage.js to create a short circuit </span>\n<span class=\"token comment\">// for local testing. </span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">===</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost detected!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    auth<span class=\"token punctuation\">.</span><span class=\"token function\">useEmulator</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:9099\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">useEmulator</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>2 questions:</p>\n<ol>\n<li>how is the cloud resources setup?</li>\n<li>why auth and db has different ways to useEmulator?</li>\n</ol>\n</blockquote>\n<h3 id=\"firestore-database\" style=\"position:relative;\"><a href=\"#firestore-database\" aria-label=\"firestore database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Firestore Database</h3>\n<ul>\n<li><strong>Firestore Database</strong> is a NoSQL DB but acting like a relational database\n<ul>\n<li>In the tutorial, there are 2 \"collections\", or tables: <code class=\"language-text\">items</code> and <code class=\"language-text\">carts</code></li>\n<li>item doc schema\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>description</th>\n<th>imgURL</th>\n<th>name</th>\n<th>price</th>\n</tr>\n</thead>\n</table>\n</li>\n<li>carts doc schema\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>itemCount</th>\n<th>ownerUID(same as id)</th>\n<th>totalPrice</th>\n<th>collection[item-id]</th>\n</tr>\n</thead>\n</table>\n</li>\n</ul>\n</li>\n<li>To access the data, the pattern is <code class=\"language-text\">db.collections(\"carts\").doc(uid).collection(\"items\").doc(item-id)</code></li>\n</ul>\n<blockquote>\n<p>How is the db schema defined? Or, is it required to be defined?</p>\n</blockquote>\n<h3 id=\"cloud-function\" style=\"position:relative;\"><a href=\"#cloud-function\" aria-label=\"cloud function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Function</h3>\n<ul>\n<li><strong>Cloud Functions</strong> can be set to listen to Firestore updating events. In local emulator, it works like:</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 431px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8b857c4224833205cd28459d5db47400/9cb4e/87bc9a17c0f38eea35af3040002aadc231e74b824dcebafbda88eb413c3acd62.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.16326530612245%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADTUlEQVQ4y41TS2wbVRQ9dj5OM2k8CaQ0bovCAgRCEVQiSF0QQlWohGQEiKBKUBYghNhQyRuSHYEGRYQkRZWABliAKIiFBUJCcSAbNo1JHNsdSIgb17HnP/GMp2N7QLjjXvQcp4uIBU86Ou9z333n3vsu8D+HqqogogYURfnZNE0yTbNmmqZnmuZNttZ1XWa2rQDa/gN+dtjXBdAOQLFRH1ufCp/Bzs5OQdM0UlW1zphBURQqFos1ZtMFoBNAB4ADTWZ7gV1tLaBPAZoE7rv7MM4MD0DX9WupVIri8fg/a2trtUQiUVteXvZkWa6yGwebitjwNZk9EAh2AN++BBDdjvwhAP2O4+TL5TJVKhVivDe3LIv2FPr3payjCdCXAP2A9vrH3X/kJnsm2KPZzPrLqixNFbazk6qqvSNLhXdlcXtKUZRz4DjuYCgUCoyMjPgHBwdbw+Gwn+f5Lo7rDDDhRzjgeAgD1Tnuwq+RrrMAglNfLDaKw9TOXfjodrF+if3UUNMLoHsfeMAfbKoNNSNoB3AH29h6ERCnjw79+V7f268cA9bPHxvOvn/orYb16OgoNzMzw0cikSDD2NhYcHZ2lm/m9dDFF9of+Pti79zs822PjJ/yIzfR0UbzPOqf9IzTfF+N/poAfd5/nj7rU37sRguKxaJg23a+Wq1ed133erlc3rIsS9NU+TILI/pa4KR36XCF5juP06UDkKePtDzDA+NPgI8M4+Hw/cBzD+Loq0MYevoeAKwyhmFQMpmk1dVV2tjYIMdxqFQqre+GjkdZuojasPX9G9CySVxJXdv9T0D34InTbN4DYODs6+eAzc1NLx6Pe7FYzFtYWPCWlpZqzHEulxNCoX703nkX6E1gO/ENLn/9FT6c/qBV1/VoybIydsm6apqmcOOGna6UnauGYfwGwzAabcOU7oEp1nV9hYX87OnHfLe+e9z3+5WYL51KIh5f7jUMoyxJEomiSLIsUz6fp0KhwDqFUCgUTsiy/KQkSSf3oKrqU9ls9l7btlmbQdM0pNNpXyaTQTKZ7NE0TRUEgVZWVm4KguAlEgmPdYooinVIktS4sB+5XA6O48B1XeaMOcLi4iKi0ShnWZbIOqNardabfMt1XbJt2/sXFpgYpc9pVg8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"picture 55\"\n        title=\"picture 55\"\n        src=\"/static/8b857c4224833205cd28459d5db47400/9cb4e/87bc9a17c0f38eea35af3040002aadc231e74b824dcebafbda88eb413c3acd62.png\"\n        srcset=\"/static/8b857c4224833205cd28459d5db47400/86a2e/87bc9a17c0f38eea35af3040002aadc231e74b824dcebafbda88eb413c3acd62.png 245w,\n/static/8b857c4224833205cd28459d5db47400/9cb4e/87bc9a17c0f38eea35af3040002aadc231e74b824dcebafbda88eb413c3acd62.png 431w\"\n        sizes=\"(max-width: 431px) 100vw, 431px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>client requests to update the Firestore</li>\n<li>The Cloud Function <code class=\"language-text\">calculateCart</code> listens for any write events (create, update, or delete) that happen to cart items by using the <code class=\"language-text\">onWrite</code> trigger</li>\n<li>The <code class=\"language-text\">calculateCart</code> function reads all of the items in the cart and adds up the total quantity and price, then it updates the \"cart\" document with the new totals.</li>\n<li>The web frontend is subscribed to receive updates about changes to the cart. It gets a <strong>real-time</strong> update after the Cloud Function writes the new totals and updates the UI.</li>\n</ol>\n<ul>\n<li>Cloud Function supports unit test to interact with emulator firestore</li>\n</ul>\n<h3 id=\"security-rules\" style=\"position:relative;\"><a href=\"#security-rules\" aria-label=\"security rules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Security Rules</h3>\n<ul>\n<li>Firebase uses <strong>Security Rules</strong> to control \"who has access to which data\"</li>\n<li>What if there are no match statements for an operation?\n<ul>\n<li>Rules deny by default. If an operation does not match any rules defined in the rules file, access will be denied.</li>\n<li><strong>Locked mode</strong>, or Production mode, is making that implicit denial an explicit denial by matching all documents and denying all access.</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>What does above 2nd point mean?</p>\n</blockquote>\n<ul>\n<li>Exmaple rule</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">rules_version = '2';\nservice cloud.firestore {\n    // path matcher\n    match /carts/{cartID} {\n      allow create: if request.auth.uid == request.resource.data.ownerUID;\n      allow read, update, delete: if request.auth.uid == resource.data.ownerUID;\n    }\n\n    // ...\n  }\n}</code></pre></div>\n<ul>\n<li>These rules now only allow read and write access by the cart owner.</li>\n<li>To verify incoming data and user's authentication, we use two objects that are available in the context of every rule:\n<ul>\n<li>The <code class=\"language-text\">request</code> object contains data and metadata about the operation that is being attempted.</li>\n<li>If a Firebase project is using Firebase Authentication, the request.auth object describes the user who is making the request.</li>\n</ul>\n</li>\n<li>What are the key differences between <code class=\"language-text\">resource</code> and <code class=\"language-text\">request.resource****</code>?\n<ul>\n<li><code class=\"language-text\">resource</code>: Represents the Firestore document in question <strong>before the current request</strong>. So for a create request, resource.data is always null because the document does not yet exist.</li>\n<li><code class=\"language-text\">request.resource</code>: Represents the Firestore document with the changes that the user <strong>wants to write</strong>. So for a create request, request.resource.data contains the proposed document.</li>\n</ul>\n</li>\n<li><strong>Rules don't cascade over subcollections</strong>\n<ul>\n<li>By default, the rules for a document don't cascade to documents in a subcollection.</li>\n<li>It's common to want slightly different rules for documents in a subcollection.</li>\n<li>If you want the documents in a subcollection to have the exact same rules, you can use the glob syntax to match all documents recursively: <code class=\"language-text\">match /{cartId=**}</code> (do this with care).</li>\n</ul>\n</li>\n<li>When can you use a resource or make a <code class=\"language-text\">get</code> call?\n<ul>\n<li>You can use the resource object when the required data is part of the current document being read/written.</li>\n<li>If you need data outside the current document, use a get statement. Note that these operations count towards your Firestore bill!</li>\n</ul>\n</li>\n<li>If we only want to test the permission, we can do it locally. But if we need to do unit test on the Cloud function logic, we have to setup the project ID so our test framework can make a call to GCP to trigger the function.</li>\n</ul>\n<blockquote>\n<p>Why the function cannot be run locally?</p>\n</blockquote>","frontmatter":{"date":"May 30, 2022","path":"/blogs/firebase-hands-on","tags":["blog","note","firebase"],"title":"Firebase Hands-On","description":"Note to streamline the steps of learning Firebase framework."}}},"pageContext":{"prev":{"frontmatter":{"path":"/blogs/firestore-learning","tags":["blog","mymanual","firebase","firestore"],"password":null},"internal":{"content":"\n```toc\n```\n\n## Document-Dollection Model\n1. **Document** is similar to json dictionary, it contains one or multiple **fields** like below:\n```\nDocument\nbrid_type: \"swallow\"\nairspeed: 42.733\ncoconut_capacity: 0.62\nisNative: false\nicon: <binary data>\nvector: {\n    x: 36.4255\n    y: 25.1442,\n    z: 18.8816\n}\ndistances_traveled: [42, 39, 12, 42]\n```\n2. *Collection* is a collection of documents. It can ONLY contain documents.\n3. Document can be only < 1MB size.\n4. Document cannot contain another do cument. It can contain **sub-collection** but not other document directly.\n5. The root of a Firestore tree can only contain collections\n\n\n## Query Fundamentals\n![picture 57](images/1088f546f7610c493b736096fc47fd1f989476143839d3e0df84599bed1678d5.png)  \n1. To navigate in your database, we are will do something like: `firestore.collection(...).document(...).collection(...).document(...)`. Or, we can also access the data by providing a path to that document like this: `firestore.document(\"/users/user_123/workouts/workout_abc/history/05182017\")`\n2. In Firebase, query is **shallow** by default. If you grab a parent level document, sub collection will be grabbed.\n\n\n## Query Rules\n1. Firestore will index your fields with a \"type\". Indexing means the DB will \n![picture 59](images/d69814208d57dfcc4d996ed12242df5d796d4688893b6da929e53d4c24b18465.png)\n\n2. Idealy, query should only happen in one collections. For example we have a tree like this: [Restaurants] -> [Reviews]:\n    * We can query for one restaurant, what are the reviews which have more than 4 stars;\n    * Query spam among several collections is called Collection Group Query. For example, if we want to get all reviews higher than 4 stars amoung all restaurants, we need to define:\n        * Colleciton ID: \"reviews\"; Field path: \"rating\"; Index Scope: \"Collection group\"\n        * This will tell the DB to index the rating fields of every documents in any collection with ID of \"reviews\"\n        * The number of this kinds of CGQ is limited - 200\n        * This will index all the collections with the same name. So if there are some unrelated collections of Reviews, they will also be indexed.\n3. Firestore does not support \"query in one collection then use the queried information to make another query\". For example, we cannot query user document in users collections and then join the reviews from that user.\n4. Fields can only be queried by using \">\", \"<\", \"==\". (Because they are sorted.) The idea of Firestore querying is, it will only do query by a. finding one point in the sorted index(using binary search); b. grab adjacent items of that point. For example, \"or\" and \"not\" queries are not supported.\n5. We can join two fields in one collection, for example, we can do \"query all restaurants **city=='SF' and cuisine=='Japanese'**\". This is done by doing \"zig-zag\" querying.\n    ![picture 65](images/8c56796cf1fb4bd8eeeddce02aaa194e6ef268f9d5ef3b5e412bdb4834258af9.png)\n    * Above Zig-zag query makes sense when the query is \"equal and equal\". For \"**less and equal**\" type of query, it's tricky, because the zig-zag only works when the ID is sorted, but for \"less-than\" query, ID is not sorted.\n    ![picture 66](images/a470972d8c16bbbfd7d93b2b5c774cea2065b9b96cfd5b508d7000e9930ab63b.png)  \n    * for this kind of query pattern, we can create `composite indexes` for this type of query - `zuocode_rating`:\n    ```json\n    {\n        restaurants:[{\n                name: \"BurgerThyme!\"\n                address: {\n                    addr_1: \"123 Fake Street\"\n                    city: \"San Francisco\"\n                    state: \"CA\"\n                    zip: \"94045\"\n                }\n                cuisine: \"Burgers\"\n                avg_rating: 4.76\n                zipcode_rating: \"94045_4.76\"\n            }]\n    }\n    ```\n    * Firestore can do this for us **automatically**. We can manually use Firestore UI to create this composite index or, we can run the query and Firestore will detect this kind of query and generate link for us to create them.\n    * With this technic, we can do \"equal\\equal\\equal\\...\\equal\\less_than(more_than)\" query.\n6. Array in Firestore does not support 'insertAt(idx, el)', 'deleteAt(idx, el)', 'retrieve(idx)'\n    * ![picture 63](images/a8efbb759341969c0e18eaf4ca7b1f2ddde16e6f99ab2b0a5f566557a0d5ef01.png)  \n    * For above collections, we can make query like: `collection(\"dickens_books\").where(\"keywords\", \"array-contains\", \"drama\")`\n    * This can be done because behind the scene, Firestore is converting the keywords list to a map: `keywords: [\"orphan\", \"crime\", \"London\", \"thieves\"]` -> `keywords: {\"orphan\": true, \"crime\": true, \"London\": true, \"thieves\": true}`\n\n## Data Structuring\n1. Do not make document too big (size[1mb max] and fields[20,000 fields]):\n    * Document has limits\n    * Document cannot be retrieved (and controlled by security rule) partially\n2. And, do NOT make document too small (fragmented)\n    * data retrieving is shallow\n    * you are billed by the number of reads and writes you perform\n    * Do not pre-maturely optimize the data structure in order to reduce billing\n    * Queries find documents in single collection\n3. Put data in the same document if they are always displayed together\n4. Put data in collection if **you are going to search for individual piece of the data or if you are expecting it to have rome to grow**\n5. As an exmaple of restaurants database, let's say we store \"reviews\" as a sub-collection under restaurant document. And in our app, we are going to display one restaurant with several (not all) reviews. For this use case, what we can do is create a field inside of restaurant document for \"**review_preview**\" and store latest (or some other order) reviews. We have Cloud Function to keep this in sync.\n6. For \"flag\" style data, we can either store a map of key->`true` or, we can store them in a list. But, according to the video, the approach of list will not allow you to do 2 attributes query. List is friendly for security rules, like \"who is allowed to edit the restaurant\".\n    ```json\n    {\n        name: \"some restaurant\"\n        cuisine: \"French\"\n        rating: 4.92\n        attributes: {\n            takes_reservations: true\n            romantic: true\n            kid_friendly: false\n        }\n        editors: [userID_2852, userID_4582]\n        // or, better solution for this editor list, so we can do security rule as:\n        // allow write if: restaurant.roles[userId] = \"editor\"\n        roles: {\n            userId_2852: \"editor\"\n            userId_4571: \"editor\"\n            userId_8123: \"owner\"\n        }\n        // however, this approach might leak some information for security reason, a better option is to store this kind of information outside of this collection\n        // or, we can have a sub-collection called \"private data\" and only contain this kinds of secrity data\n    }\n    ```\n\n## Security Rules\n> Below will not cover security coming from server libraries, for example: cloud functions.\n1. A security rulle will specify: \n    1. what specific documents you are securing\n    2. what logic you are going to secure them.\n2. here is an example of security rule, it really just an example, does not make too much sense\n    ```\n    service cloud.firestore {\n        match /databases/{database}/documents {\n            match /{document=**} {\n                // Completely locked\n                allow read, write: if false;\n            }\n            // ----------------------------------\n            match /restaurants/{restaurantID} {\n                // (i)\n            }\n            match /restaurants/{restaurantID}/reviews/{reviewID} {\n                // the rules placed here is the same as what it has in (ii)\n            }\n            // ----------------------------------\n            match /restaurants/{restaurantID} {\n                match /reviews/{reviewId} {\n                    // (ii)\n                    allow write: if reviewId == \"review_234\"\n                }\n            }\n            // ----------------------------------\n            match /myCollection/{docId} {\n                allow read: if request.auth.token.email.matches('.*google[.]com$');\n            }\n        }\n    }\n    ```\n3. the `{database}` in this rule is to \"wild cards\" all the database in firestore. 2 kinds of wildcard:\n    1. Single element wildcard - `{database}` or `restaurantID`:\n        1. it's just to say: go ahead and match a single path element, either a document or a collection, and stick it into a variable with the name that I specified here.\n        2. so at the place - (i), we will have a variable named `restaurantId` and its value is the ID of the restaurant doc\n        3. this variable will be available in nested security rule, like place (ii)\n    2. \"Rest of the document path wild card\" - `{document=**}`\n        1. it says: go ahead and match the rest of the path and stick it into this variable here\n        2. now the `document` will be the rest of the path\n4. **WARNING**: the security ruls for the parent document will not be cascade to the nested collection!\n5. **WARNING**: security rules will be an *ORDERED* matcher list. First will be applied and if it does not work, the second will be applied... So be careful of some \"powerful\" rules which can override following rules.\n6. For the rule string - `allow read: if reviewId == \"review_234\"`:\n    1. only `allow` keyword is provided. There is no `disallow`. If you want to \"block\", you can `allow read: if false`\n    2. verbs:\n        1. `read` includes `get` and `list`\n        2. `write` includes `create`, `delete` and `update`\n7. `request` is the \"input\" of the security rule. It contains 2 things:\n    1. auth\n        1. whether they're an actual signed-in user: `allow read: if request.auth != null`\n        2. allow people only when the email from the domain of \"google.com\" and verified: `allow read: if request.auth.token.email.matches( '.*google[.]com$') && request.auth.token.email_verified;`\n    2. resource\n        1. security rule can be used to \"define the data restriction\": `allow create: if request.resource.data.score is number && request.resource.data.score >= 1 && request.resource.data.score <= 5`\n        2. with \"resource\", we can also define some rules to \"only let the owner to edit/read the document\": `allow update: if request.resource.data.reviewerId = request.auth.uid`\n8. `resource` is another object can be used in security rules representing the existing document in database:\n    1. for example, user cannot change the score: `allow update: if request.resource.data.score == resource.data.score`\n9. **WARNING**: security rule is NOT a filter, it will block a request to a collection and any of the documents failed the security rule.\n10. `get()` function can allow you to retrieve data from another document for security rule validation:\n    1. `allow update: if get(/databases/$(database)/documents/restaurants/$(restaruantID)/ private_data/private).data.roles[request.auth.uid] in [\"editor\", \"owner\"]`\n11. Custom Auth Claim: Cloud function can be used to define some fields for security rules. The number is limited.\n12. Security Rule support functions:\n    ```\n    function doesUserHaveGoogleAccount() {\n        return request.auth.token.email.matches('.*google[.]com$') && request.auth.token.email_verified\n    }\n\n    //...\n    allow update: if doesUserHaveGoogleAccount()\n    ```\n\n## Pagination\n```javascript\nmyQuery = restaurantRef.whereField(\"city\", isEqualTo: \"Tokyo\")\n    .whereField(\"category\", isEqualTo: \"tempura)\n    .order(by: \"rating\", descending: true)\n    .limit(to: 20)\n```\nAbove query Will provide the first 20 documents matches this query.\n\nTo get the next batch of data:\n```javascript\nnextBatch = restaurantRef.whereField(\"city\", isEqualTo: \"Tokyo\")\n    .whereField(\"category\", isEqualTo: \"tempura)\n    .order(by: \"rating\", descending: true)\n    .limit(to: 20)\n    .start(after: [\"Tokyo\", \"tempura\", 4.9])\n// or \nnextBatch = myQuery.start(after: [\"Tokyo\", \"tempura\", 4.9])\n// however, this will potentially skip documents. \n// So we can do:\nmextBatch = myQuery.start(after: previousDoc)\n// previousDoc is the LAST document of the previous batch\n```\n\n**WARNING**: if the collection is constantly updated, for example some documents are deleted and inserted, those updates might be skipped. To avoid this, in the 2nd query, you should increase the `limit(to: 40)` then `60`.\n\n## Transactions\nBatch Write is for Atomic: DB will make sure that one batch write will success for all or failed for all'\n\nTransaction is for Most-up-to-date, 5 steps to perform a transaction: \n1. before writing to DB, it will first read the dcoument; \n2. then, client will have some logic to update the data in the document; \n3. the update will be performed; \n4. then, double check the right change was made; \n5. finally, all changes will be commited.\n\n**When we want to increment or decrement a value, we need to use transaction.**\n\n## Offline Support\n> On Andriod and iOS devices, offline support is enabled by default.\n### Read\nThe offline mode for read works in Firestore likes following:\n1. [online] You queried Firestore for the top 30 sushi restaurants in SF sorted by price\n2. [online] You queried for the top 30 burger restaurants in SF sorted by price\n3. [offline] now you can still query for top 30 restaurants in SF sorted by rating. This query will work across the cache data.\n\n### Write\nWhen you make a change to a document, that data will be store on the local device and whether you are online or not, you data will immediately give you the appearence that your change has gone into effect. Any real-time listeners that are watching this data will trigger with your updated data.\n\nBy the meantime Firebase will take your change and attempt to send it to the server. After you are online, Firebase library will update your data for reals, and will remove that pending write.\n\nAs a summary, offline write will be queued and will be replayed when device goes online. If multiple devices are writing the same document, last write (to the server, even it actually happened before the other) will be applied.\n\n### Notes:\n1. Firebase library for web is not enabled for offline support by default\n2. The callback function of `collection.add()` will not be triggered when it's in offline mode, because your app is still waiting for the response from the server. When use Firebase, because it has a cache, we don't need to add a callback to handle the fresh data.\n3. Transaction will fail in offline mode\n4. Offline cache is not indexed so the query will take some time.\n5. The default behavior is good enough to ensure a good offline experience.\n\n## Realtime Support\n> The main takeaway here is that you should start thinking of realtime as your default behavior, then only switch to one-time fetch call only when you have a good reason to make that change.\n\n## Cloud Function\n> When an database action is fired, you can hook a cloud function to this action and execute some custom logic.\n### Why?\n1. With cloud function, \"backend logic\" is hosted at the backend (instead of managed by client). So you can easily update it by deploying to backend instead of updating client application;\n2. Clients are not trustworthy;\n\n### Notes:\n1. Infinite loop: when you have a cloud function executed `onChange()`, and in this function you modify the data, the same function will be triggered again.\n2. admin serverside sdk will bypass the security rules.\n3. Lazy import is preferred because otherwise all of your cloud function will load those library"}},"next":{"frontmatter":{"path":"/blogs/detailed-steps-to-setup-diode","tags":["blog","checkout dash b","ng project","aws","amplify","sandbox"],"password":null},"internal":{"content":"\n```toc\n```\n\n## 1. Minimum Prerequisites\n1. Operating System: Windows (TODO: difference in XOS is minimal, will update when available)\n2. Amplify is an service hosted on AWS. An AWS account requires a credit card / bank account and phone number to be registered. No charge is expected if you are following this instruction as AWS has [a free-tier policy](https://aws.amazon.com/amplify/pricing/) for the first year. At the end of this instruction, I will also illustrate how to delete the app from your account.\n3. A Github account.\n4. 30 mins free time.\n\n## 2. Create a new AWS Account Creation\n**Skip this section if you already own AWS account.**\n1. Log to: https://portal.aws.amazon.com/billing/signup#/start/email, sign up for a new account. Credit card, phone number, address is required.\n![picture 2](images/c2ca6d550b7ca54947ce9abb9efe6bdf4864f91ed4b862ffecc96ccdcf8e2a03.png)  \n\n## 3. Host the App on Github\n1. Log to: https://github.com/new, create a new repo named \"diode\". No necessary to change anything else. Note, in my screenshot, as I have already had one repo named \"diode\", I used \"diode_\" as its name. Then hit \"Create Repository\"!\n![picture 4](images/0aea8dc1ef09888ad791c1c5aef8e54f281c16349fa8a721ede6619af3e4b70e.png)  \n\n2. You will be able to see this page after the repository is created\n![picture 5](images/538af9c32e622b30da7e9586d7aa4396acfd4e0ae5f23b1244faa9382f091dbb.png)  \n\n3. **Skip step-3.3 to 6 if you already have Git installed on your system.** We need to install Git for version control. https://git-scm.com/download/win. Select \"64-bit Git for Windows Setup\" to download Git.\n![picture 7](images/965c065eca4bf8f361326e79c1d617cae44eaa5db174b4de78f5a8a35ff0023e.png)  \n\n4. Click the downloaded and \"next\" all the way down to install it.\n![picture 8](images/1193ff3084ad45dfcac1b1b41d4a294bcf3fbcd8f89af45ad832d81c8c990b5b.png)  \n\n5. Now we want to verify the installation. On Windows system, click [Windows logo] then type `powershell` and hit [enter], you should be able to see something like this. We call it terminal.\n![picture 9](images/dd6a84f84f02d7b2e7a675b54656b1d52c4d121c6d3883e80ceaf5413908beff.png)  \n\n6. Type `git --version` hit [enter]. If you see this, we are good!\n![picture 10](images/b972587efc43294628ff2400f87f26cce0d073ce8e9ca6cbf1f817aa803f4939.png)\n\n7. Run `mkdir diode` to create a new directory then `cd diode` to move into it. Note, still, in my screenshot, I used \"diode_\" instead of \"diode\" to avoid duplicates.\n![picture 12](images/0ebd1022f394b1e04309fd86389e451fa03c00abefffdc7c5f870d1459b0f529.png)  \n\n8. **Skip step-3.8 if you already have your local Git configured for Github.** Don't forget to setup git username and email as we are in the sandbox by running following 2 commands: `git config --global user.name \"<your-github-username>\"` and `git config --global user.email \"<your-github-commit-email-address>\"`. Note, the Github commit email address will not be your account email address because Github will keep your email private by default. You can go to your Github mainpage, to find your commit email.\n![picture 19](images/f726429ea6c70227ba7bdb4a5a52df56545b124eab0daec8769c46908fdcb0d7.png)  \n![picture 16](images/f52f2e5c3e5b2c9f76d4d33d0346a8186cefc78a2fd9fad2f4332d00c13a877f.png)\n\n9. Now, go back to the browser we used to create the new repository, click the icon in red rectangle to copy all the commands listed.\n![picture 11](images/1b233afab507335a89ece9f8d928ef2a477f16422e36bf86d02fa2f6d2436587.png)  \n\n10. Copy paste them into the `powershell` and hit [enter]. It will ask you to input Github credentials to login if you don't have your Github credentials configured.\n![picture 15](images/b33bdeb0dc7f9fb8afc948fafea5dfc54b0eb46ed7f360e2e717838c9f804bee.png)  \n\n11. Then you should see this, indecating that the Git is setup!\n![picture 20](images/726e46e4948cfe56ad32ed8c8b3c4adea20d61aef2906df63a8897d197654c65.png)  \n\n## 4. Setup Develop Environment\n1. **Skip Step-4.1 if you already have Node.js installed.** Diode is a Javascript application. We will use [node.js](https://nodejs.org/en/) for package management. Go to https://nodejs.org/en/ and click the version - \"Recommended for most of users\". Download the executable and install it.\n\n2. **Skip Step-4.2 if you already have VSCode installed.** Download and install VSCode from here: https://code.visualstudio.com/Download. You should see the \"Welcome page\" after the installation. It might be different than mine but it's fine.\n![picture 21](images/a657a8990db0bf7f1d95de85e9db3fb76dec037ca8546766e24e48207d0d566c.png)  \n\n3. Click \"Open Folder\" and select the folder named \"diode\" you created above. If you followed my instruction, it should be inside your user's home (on Windows, it usually is `C:\\Users\\<your-user-name>\\diode`).\n![picture 22](images/3c13de3d6d4aace7091c902c4142c3f89df07d92020c1976b52f274b5e888317.png)  \n\n4. Now, we can execute our command in VSCode by clicking \"Terminal\" > \"new Terminal\"\n![picture 23](images/f6676f8b602a9ee61e14c81abed3b64454b96ced45c7201f44c4d1b09e085c98.png)  \n\n5. run following commands to verify that dev env is ready: `node --version`, `npm --version`, `npx --version`. If you see similar output, we are good.\n![picture 24](images/5de138b5a0a1c00b278dd480118d5aa5119b8d7b2b86c0decdc91f4e4325c834.png)  \n\n6. run `npx create-react-app .` to create an React app. If the command is paused and asks you \"OK to proceed?\", simply click \"y\" indecating \"yes\" and hit [enter] to proceed.\n![picture 25](images/12d7c1e1de60ac37f4e5ed7992bbb8e3b2b64addf4efb81ee18f9b9e047177ae.png)  \n\n7. run `npm i -g @aws-amplify/cli` to install Amplify CLI.\n\n8. run `npm i aws-amplify @aws-amplify/api @aws-amplify/auth @aws-amplify/core @aws-amplify/ui-react` to install all dependency packages.\n![picture 26](images/850df35ae8332c59f3ec2e47fcefff1c8fb9eef0e8c9c307314d7075edfb4f62.png)\n\n9. set a checkpoint using Git by running `git add .` then ` git commit -m \"All requirements installed\"` and `git push`.\n![picture 27](images/85683b9b1bc65ef6cd816bae12646821adbfe975f052fa229e578d685082b65c.png)  \n\n## 5. Amplify Code Changes, Finally...\n1. run `npx amplify init` to initialize an Amplify project. Hit [enter] to use default selections until you see \"Press Enter to continue\".\n![picture 28](images/682e4b1f3390a4722f5b1b139c672dc96150338202f619ebe9fd566ca809c0df.png)  \n\n2. We should see the browser pops up an AWS login page automatically. Use the email address and password we used in Step-2.1 to login. Then go back to VSCode and press [enter].\n\n3. You will be asked to select an AWS region. Ideally, you should check the list here and select one region near you geographically. But here, as we are doing a demo, we will select 'us-east-1' for demo consistancy.\n![picture 30](images/faf82d8394a64c76b5c5de8676981e06ca56100e7f5200a0dde64dc935c3e3de.png)  \n\n4. Hit [enter] until you see \"Press Enter to continue\" again and browser should pop up again.\n![picture 31](images/0f6fc08988f2ce9a5aa9f4f6c9b6fcca411b21f59b879e9675b26477f18f629c.png)  \n\n5. Make sure you select \"Access Key\" here. \n![picture 32](images/da9a5e7a4eb92dcf3eed3e4dd1087224156c16c9a8d680f0adc1411dd1f5cd41.png)  \n\n6. Then \"next\" all the way to the end. And you should see semething like this. Note, **it is very important to keep this page open until you finish step-5.7.** Now go back to VSCode.\n![picture 33](images/730f5125bc6e284252dac4e8b462480f7d94cc46dc9b395bcd3b36aee5e23fa4.png)  \n\n7. Press [enter] and continue. It wil ask you for \"accessKeyId\" and \"secretAccessKey\". Copy paste them from the browser above in step-5.6 and click [enter] all the way down. \n![picture 34](images/535fa93e7f6ef23d1c8f3256650461f1849ce5a50a53bc80d76e9960a0de804c.png)\n\n8. If you see this, we are great!\n![picture 35](images/6198427e6edca5d0ba3ff3654eccfe354db98ab29a833c031fcba9546c796f2d.png)  \n\n9. Then run `npx amplify add api`. Here, we need to be a little bit careful as not all selections are default\n    * \"Select from one of the below mentioned services\" - GraphQL\n    * \"Here is the GraphQL API that we will create. Select a setting to edit or continue\" - **DON'T CONTINUE**, use \"up arrow\" and select \"Authorization modes: API key\"\n    * \"Choose the default authorization type for the API\" -  Amazon Cognito User Pool\n    * \"Do you want to use the default authentication and security configuration?\" - Default configuration\n    * \"How do you want users to be able to sign in?\" - Username\n    * \"Do you want to configure advanced settings?\" - No, I am done.\n    * \"Configure additional auth types?\" - N\n    * continue\n    * \"Choose a schema template:\" - Single object with fields\n    * \"Do you want to edit the schema now?\" - Y\n    * You should see a new text file named \"schema.graphql\" pops up\n![picture 36](images/ea6480e796ed340219c15efb11bdc884805814153bc678914e9a865959497342.png)\n\n10. Copy paste all content [from my example code](https://github.com/ZzzGin/diode/blob/main/amplify/backend/api/toggle/schema.graphql) to \"schema.graphql\"\n![picture 37](images/30a2f336e62ff28985d17884a9a15d9f7241d61080e0a5abd6aa79e4367b0ca7.png)  \n\n11. run `npx amplify push`, wait for a while and it will pause for your confirmation and some code generation options, hit [enter] to proceed all with default options. Then go grab a cup of coffee and enjoy 5 mins.\n![picture 39](images/f83678588005557ad1d16c53f8084260ac36e59a88138ee8b8a92a8ec05c009e.png)  \n\n12. If you see this, we are great! All backend things are built and we can start developing the frontend\n![picture 40](images/b8275678e356547c19698f1826d6d4864cc36711d05b5ce9ed8e843aa6cc8903.png)  \n\n13. Delete files in red rectangles. \n![picture 41](images/ffc271109194957e5c49daa5970c66cf3721475e16509d18a01d16d03a6c2af1.png)  \n\n14. Remove all content in 'index.js' and copy [all content here](https://github.com/ZzzGin/diode/blob/main/src/index.js) into 'index.js'\n\n15. Remove all content in 'App.js' and copy [all content here](https://github.com/ZzzGin/diode/blob/main/src/App.js) into 'App.js'\n\n16. Remove all content in 'App.css' and copy [all content here](https://github.com/ZzzGin/diode/blob/main/src/App.css) into 'App.css'\n\n17. Local testing by running `npm run start`... And... Yes it will take about 1 minute to build our code... Nice! We see our work!\n![picture 42](images/501abd0240bee233a6f33e95082b39022bdb4d43cf51966e42862364e0f16171.png)  \n\n18. Create an account and log in. Play with it to verify the function is good.\n![picture 43](images/411607f2250fcac40516c496fa024de16d96c3600521e9b4799b640a6ef71d65.png)  \n\n19. We can now go back to VSCode and [ctrl-c] to terminate the local server\n![picture 44](images/2c71206446cf2c4fdd21ff47a8cdd222aa3c3967b5db7ec74e1bcebce84d4640.png)  \n\n20. As another checkpoint, we run `git add .`, `git commit -m \"all code changes for diode\"`, `git push` to push our changes to Github.\n\n## 6. Create a Deployment Pipeline\n1. We are now going to link our Github code repository to the Amplify App. We navigate to: https://us-east-1.console.aws.amazon.com/amplify/home?region=us-east-1#/. Note, this is for region \"us-east-1\", if you selected different region in the step-5.3, you need to choose the right region.\n![picture 45](images/d32439eb58c5eb66f13718f8d9af6c08fbbfffd8525dbd243a1694dc91e2371c.png)  \n\n2. Our diode app is here! Click on it, and we can see AWS console provides an UI wizard to config Github as code source for continous deployment.\n![picture 46](images/de5c2237600e8e9b5181b428aeba25c94e1a442cbf2401ae00ba1fdf6447ab8f.png)  \n\n3. UI is good but we are developers, we love terminal interface. So, let's go back to VSCode and run `npx amplify hosting add`\n    * \"Select the plugin module to execute\" -  Hosting with Amplify Console\n    * \"Choose a type\" - Continuous deployment\n    * This step navigate you to the same page we got in step6.2\n\n4. Select \"Github\" then \"connect branch\". Steps will be required to authorize the connection from Amplify to Github.\n![picture 47](images/f184e49850722641a6b30c5fd87b0dab39d3d15f7c1ca472e4902d3694e0e2df.png)  \n\n5. Select the code repository name and branch name - we only have one branch - \"main\", then click \"next\"\n![picture 48](images/cdca350ea848722338b212da9dc5a04b99cfd36fe6c8e46390be7527abf128b1.png)  \n\n6. In the next step, we are asked for some configurations. One question asking \"Select an existing service role or create a new one so Amplify Hosting may access your resources\" does not have an eligible selection. We need to create a new one. Click the \"Create new role\".\n![picture 49](images/3efec49b7743f1e04a258461e3576d9704c5499356d8f4712106e6b5653343e1.png)  \n\n7. Click \"next\" all the way down to create a new role for Amplify deployment. A role named \"amplifyconsole-backend-role\" will be created.\n![picture 50](images/644a9054f95a4403313d42e77abf3d46bde95e139420ddf9aa4b09c108a0a556.png)  \n\n8. Back to the page in step-6.6, refresh the list and select the newly created role. Then click \"next\" all the way down.\n![picture 51](images/60c3a423c101f02176b0509ee461359343e3a1c7c77131fd92fc31f26664ead1.png)\n\n9. Wait for the pipeline to refresh. It will take around 10 mins.\n![picture 52](images/e2154ba6aa9db29bf79ddc2ea7af2c17c88835684f439cf7f63180213cd589ec.png)  \n\n10. Great! Our first deployment is done! We will be able to access our public web app by clicking the URL on this page.\n![picture 53](images/68aeddfee9d297c7e9b1fe29adbea89522545f6021db372b2a96248c8021972f.png)  \n\n11. The above pipeline will be helpful when you make some futher change to the codebase. Once you push your change to Github, this pipeline will be triggered and deploy your new change to public. Try that by yourself!\n\n## 7. Clean up\n1. To delete the app you just created, simply navigate to the same page of step-6.2. You should be able to find a button for \"Actions\". Click it and \"Delete App\". Follow the instructions and the app will be deleted. With this one click, all resources you created in this hands-on cookbook will be deleted. "}}}},
    "staticQueryHashes": []}